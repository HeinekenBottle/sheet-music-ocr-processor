<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="utf-8">
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 8px;
        color: #333;
      }
      
      .header {
        border-bottom: 1px solid #ddd;
        padding-bottom: 8px;
        margin-bottom: 10px;
      }
      
      h3 {
        color: #4285f4;
        margin-top: 5px;
        margin-bottom: 10px;
      }
      
      .no-selection {
        padding: 15px 0;
        color: #666;
        font-style: italic;
        text-align: center;
      }
      
      .trade-info {
        background-color: #f5f5f5;
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 15px;
      }
      
      .trade-date {
        font-weight: bold;
        margin-bottom: 5px;
      }
      
      .trade-details {
        font-size: 0.9em;
      }
      
      .setup-type {
        font-weight: bold;
      }
      
      .result {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 3px;
        margin-left: 5px;
      }
      
      .win {
        background-color: #d9ead3;
      }
      
      .loss {
        background-color: #f4cccc;
      }
      
      .chart-container {
        margin-bottom: 15px;
        border: 1px solid #ddd;
        padding: 10px;
        border-radius: 4px;
        background-color: white;
      }
      
      .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }
      
      .chart-name {
        font-weight: bold;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 200px;
      }
      
      .chart-actions {
        display: flex;
      }
      
      .action-button {
        background: none;
        border: none;
        cursor: pointer;
        color: #666;
        margin-left: 5px;
        font-size: 16px;
        padding: 0;
      }
      
      .action-button:hover {
        color: #4285f4;
      }
      
      .chart-image {
        max-width: 100%;
        height: auto;
        display: block;
        cursor: pointer;
        border-radius: 2px;
      }
      
      .upload-section {
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px solid #eee;
      }
      
      button.main-button {
        background-color: #4285f4;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        width: 100%;
        margin-top: 8px;
      }
      
      button.main-button:hover {
        background-color: #2a75f3;
      }
      
      button.main-button:disabled {
        background-color: #a9c3f5;
        cursor: not-allowed;
      }
      
      .file-input-container {
        margin-bottom: 8px;
      }
      
      input[type="file"] {
        width: 100%;
        font-size: 14px;
      }
      
      .no-charts {
        text-align: center;
        padding: 20px 0;
        color: #666;
        font-style: italic;
      }
      
      .loader {
        display: none;
        text-align: center;
        padding: 20px 0;
      }
      
      .loader::after {
        content: "";
        display: block;
        width: 30px;
        height: 30px;
        margin: 0 auto;
        border-radius: 50%;
        border: 3px solid #ddd;
        border-top-color: #4285f4;
        animation: spin 1s linear infinite;
      }
      
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h3>Trading Charts Gallery</h3>
    </div>
    
    <div id="selected-info" class="no-selection">
      Select a row to view related charts
    </div>
    
    <div id="loader" class="loader"></div>
    
    <div id="charts-container"></div>
    
    <div class="upload-section">
      <h4>Add New Chart</h4>
      <div class="file-input-container">
        <input type="file" id="chart-upload" accept="image/*">
      </div>
      <button class="main-button" id="upload-button" disabled>Upload Chart</button>
    </div>
    
    <script>
      // Variables to track current selection
      let currentRowInfo = null;
      const uploadButton = document.getElementById('upload-button');
      const chartUpload = document.getElementById('chart-upload');
      const loader = document.getElementById('loader');
      const chartsContainer = document.getElementById('charts-container');
      
      // Initialize the sidebar
      function initialize() {
        // Get currently selected row info
        google.script.run
          .withSuccessHandler(updateSelectedInfo)
          .withFailureHandler(handleError)
          .getSelectedRowInfo();
          
        // Set up event listeners
        uploadButton.addEventListener('click', uploadChart);
        chartUpload.addEventListener('change', function() {
          uploadButton.disabled = !chartUpload.files.length;
        });
        
        // Listen for selections in the sheet
        window.addEventListener('selectionchange', function() {
          // This won't actually fire in most contexts, but we'll leave it as a fallback
          refreshSelection();
        });
        
        // Set up a polling mechanism to check for selection changes
        setInterval(checkSelectionChanged, 2000);
      }
      
      // Last known selection
      let lastKnownRow = null;
      
      // Check if selection has changed
      function checkSelectionChanged() {
        google.script.run
          .withSuccessHandler(function(info) {
            if (!info) {
              if (lastKnownRow !== null) {
                lastKnownRow = null;
                updateSelectedInfo(null);
              }
              return;
            }
            
            if (!lastKnownRow || lastKnownRow !== info.row) {
              lastKnownRow = info.row;
              updateSelectedInfo(info);
            }
          })
          .getSelectedRowInfo();
      }
      
      // Refresh the selection when the user clicks on a different row
      function refreshSelection() {
        showLoader();
        google.script.run
          .withSuccessHandler(updateSelectedInfo)
          .withFailureHandler(handleError)
          .getSelectedRowInfo();
      }
      
      // Update the UI based on selected row
      function updateSelectedInfo(info) {
        hideLoader();
        currentRowInfo = info;
        const selectedInfoContainer = document.getElementById('selected-info');
        
        if (!info) {
          selectedInfoContainer.className = 'no-selection';
          selectedInfoContainer.innerHTML = 'Select a row to view related charts';
          chartsContainer.innerHTML = '';
          uploadButton.disabled = true;
          return;
        }
        
        // Update selected trade info with extra details
        selectedInfoContainer.className = 'trade-info';
        
        // Determine result class for styling
        const resultClass = info.result.toLowerCase().includes('win') ? 'win' : 
                           info.result.toLowerCase().includes('loss') ? 'loss' : '';
        
        // Build trade info HTML
        selectedInfoContainer.innerHTML = 
          `<div class="trade-date">Date: ${info.date}</div>` +
          `<div class="trade-details">` +
          `<span class="setup-type">${info.setupType}</span>` +
          `<span class="result ${resultClass}">${info.result}</span>` +
          `</div>` +
          `<div class="trade-details">Entry: ${info.entry} / Exit: ${info.exit}</div>`;
          
        // Enable upload button if a row is selected
        uploadButton.disabled = !chartUpload.files.length;
        
        // Load charts for this trade
        showLoader();
        google.script.run
          .withSuccessHandler(displayCharts)
          .withFailureHandler(handleError)
          .getChartsForTrade(info.row);
      }
      
      // Display charts in the container
      // Update these functions in ChartSidebar.html

      // Display charts in the container
    function displayCharts(charts) {
      hideLoader();
      chartsContainer.innerHTML = '';
      
      if (!charts || charts.length === 0) {
        chartsContainer.innerHTML = '<div class="no-charts">No charts available for this trade</div>';
        return;
      }
      
      charts.forEach(function(chart) {
        const chartDiv = document.createElement('div');
        chartDiv.className = 'chart-container';
        
        // Create chart header with name and actions
        const chartHeader = document.createElement('div');
        chartHeader.className = 'chart-header';
        
        const chartName = document.createElement('div');
        chartName.className = 'chart-name';
        chartName.textContent = formatChartName(chart.name);
        
        const chartActions = document.createElement('div');
        chartActions.className = 'chart-actions';
        
        // Open button
        const openButton = document.createElement('button');
        openButton.className = 'action-button';
        openButton.innerHTML = 'üîç';
        openButton.title = 'Open in new window';
        openButton.onclick = function() { openChart(chart.id); };
        
        // Delete button
        const deleteButton = document.createElement('button');
        deleteButton.className = 'action-button';
        deleteButton.innerHTML = 'üóëÔ∏è';
        deleteButton.title = 'Delete chart';
        deleteButton.onclick = function() { deleteChartWithConfirmation(chart.id, chartDiv); };
        
        chartActions.appendChild(openButton);
        chartActions.appendChild(deleteButton);
        
        chartHeader.appendChild(chartName);
        chartHeader.appendChild(chartActions);
        
        // Create chart image
        const chartImg = document.createElement('img');
        chartImg.className = 'chart-image';
        chartImg.onclick = function() { openChart(chart.id); };
        chartImg.alt = chart.name;
        
        // Set a placeholder while loading the actual image
        chartImg.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAMLCwgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==';
        chartImg.style.minHeight = '150px';
        chartImg.style.backgroundColor = '#f0f0f0';
        
        // Add loading text
        const loadingText = document.createElement('div');
        loadingText.textContent = 'Loading preview...';
        loadingText.style.position = 'absolute';
        loadingText.style.top = '50%';
        loadingText.style.left = '50%';
        loadingText.style.transform = 'translate(-50%, -50%)';
        loadingText.style.color = '#666';
        loadingText.style.fontSize = '12px';
        
        const imageWrapper = document.createElement('div');
        imageWrapper.style.position = 'relative';
        imageWrapper.appendChild(chartImg);
        imageWrapper.appendChild(loadingText);
        
        // Add all elements to the chart container
        chartDiv.appendChild(chartHeader);
        chartDiv.appendChild(imageWrapper);
        chartsContainer.appendChild(chartDiv);
        
        // Now load the actual image data
        google.script.run
          .withSuccessHandler(function(dataUrl) {
            if (dataUrl) {
              chartImg.src = dataUrl;
              loadingText.style.display = 'none';
              chartImg.style.minHeight = 'auto';
            } else {
              loadingText.textContent = 'Preview not available. Click üîç to view.';
            }
          })
          .withFailureHandler(function(error) {
            loadingText.textContent = 'Preview not available. Click üîç to view.';
            console.error('Failed to load chart image:', error);
          })
          .getChartImage(chart.id);
      });
    }
    
      
      // Format chart name for display (remove date prefix, etc)
      function formatChartName(name) {
        // Remove the "Trade-YYYY-MM-DD-" prefix if present
        const match = name.match(/^Trade-\d{4}-\d{2}-\d{2}-(.+)$/);
        if (match) {
          return match[1];
        }
        return name;
      }
      
      // Upload a new chart
      function uploadChart() {
        if (!currentRowInfo) {
          alert('Please select a trade row first');
          return;
        }
        
        const file = chartUpload.files[0];
        if (!file) {
          alert('Please select a file to upload');
          return;
        }
        
        showLoader();
        uploadButton.disabled = true;
        
        const reader = new FileReader();
        reader.onload = function(e) {
          const content = e.target.result.split(',')[1];
          google.script.run
            .withSuccessHandler(function(result) {
              hideLoader();
              // Clear the file input
              chartUpload.value = '';
              uploadButton.disabled = true;
              // Refresh the charts display
              google.script.run
                .withSuccessHandler(displayCharts)
                .withFailureHandler(handleError)
                .getChartsForTrade(currentRowInfo.row);
            })
            .withFailureHandler(function(error) {
              hideLoader();
              uploadButton.disabled = !chartUpload.files.length;
              alert('Error uploading chart: ' + error);
            })
            .uploadSelectedRowChart(content, file.name);
        };
        reader.readAsDataURL(file);
      }
      
      // Open a chart in a new browser tab
      function openChart(fileId) {
        google.script.run
          .withSuccessHandler(function(url) {
            if (url) {
              window.open(url, '_blank');
            } else {
              alert('Failed to open chart. Please try again.');
            }
          })
          .withFailureHandler(function(error) {
            alert('Error opening chart: ' + error);
          })
          .openChartInBrowser(fileId);
      }
      
      // Delete a chart with confirmation
      function deleteChartWithConfirmation(fileId, element) {
        if (confirm('Are you sure you want to delete this chart?')) {
          showLoader();
          google.script.run
            .withSuccessHandler(function(success) {
              hideLoader();
              if (success) {
                if (element) {
                  element.remove();
                }
                // If no charts left, show "no charts" message
                if (chartsContainer.children.length === 0) {
                  chartsContainer.innerHTML = '<div class="no-charts">No charts available for this trade</div>';
                }
              } else {
                alert('Failed to delete the chart');
              }
            })
            .withFailureHandler(function(error) {
              hideLoader();
              alert('Error deleting chart: ' + error);
            })
            .deleteChart(fileId);
        }
      }
      
      // Error handler for server calls
      function handleError(error) {
        hideLoader();
        console.error('Error:', error);
        alert('An error occurred: ' + error);
      }
      
      // Show the loading indicator
      function showLoader() {
        loader.style.display = 'block';
      }
      
      // Hide the loading indicator
      function hideLoader() {
        loader.style.display = 'none';
      }
      
      // Start the sidebar
      initialize();
    </script>
  </body>
</html>